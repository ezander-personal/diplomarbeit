#! /bin/bash

declare -a cleanup

makefile="Makefile"

if [[ ! -e $makefile ]]; then
  cleanup+=("$makefile")
fi


if grep -qs "tsa remake" $makefile; then
  sed -i '/^# Generated by tsa remake/Q' $makefile
else
  echo "" >> $makefile
fi

echo -e "# Generated by tsa remake; changes behind this line might get lost\n" >> $makefile
echo -e "default: inf_all\n" >> $makefile

declare -a targets
for file in "$@"; do
  infile=$(egrep "^i:" $file | cut -f 2-)
  outfile=$(egrep "^o:" $file | cut -f 2-)
  creator=$(egrep "^# Creator:" $file | cut -f 2-)
  args="$(cat $file | grep -v "^#" | sed 's/^\(.\):\?[[:space:]]*/-\1 /')"
  if [[ -z $creator ]]; then
    echo "Warning: no creator given for '$file'!!"
    continue
  fi
  targets+=("$outfile")
  echo "$outfile: $infile $file \$(shell which $creator)" >> $makefile
  echo -e "\tDONTVIEWGP=1 $creator $(echo $args)\n" >> $makefile
done

echo ".PHONY: inf_all inf_clean" >> $makefile
echo -e "inf_all: " "${targets[@]}" >> $makefile

for file in "${targets[@]}"; do
  cleanup+=("$file" "$file.gp" "$file.eps")
done


if grep -q "^clean:" $makefile; then
  echo -e "inf_clean:\n\trm -f " "${cleanup[@]}" "\n" >> $makefile
else
  echo -e "clean:\n\trm -f " "${cleanup[@]}" "\n" >> $makefile
fi
sed -i '/^clean:/ {/inf_clean/! s/$/ inf_clean/}' $makefile

